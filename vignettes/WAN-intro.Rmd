
# **WAN: A Workflow for Distance-based Habitat Preference Analysis**

### *Case Study and Technical Guide*

---

```yaml
---
title: "WAN: Distance-Based Habitat Preference Analysis Workflow"
author: "Your Name"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{WAN Case Study}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---
```

---

# 1. Introduction

The *WAN* package provides a unified workflow for analysing spatial habitat preferences of invasive species based on distances to anthropogenic or natural habitat features.
The workflow includes:

1. Reading occurrence records,
2. Generating background points,
3. Calculating distances to multiple habitat layers,
4. Building distance–frequency tables,
5. Fitting exponential decay models,
6. Fitting linear (LM) and smooth (GAM) distance–frequency trends,
7. Generating statistical summaries,
8. Integrating habitat distances and environmental predictors into a machine-learning framework.

This vignette illustrates a complete analysis using synthetic data, demonstrating each step of the workflow and corresponding WAN functions.

---

# 2. Loading packages

```r
library(WAN)
library(sf)
library(terra)
library(dplyr)
library(ggplot2)

set.seed(123)
```

---

# 3. Constructing a synthetic study area

A simple 10 × 10 unit square is used as a study area.

```r
study_poly <- matrix(c(
  0, 0,
  10, 0,
  10, 10,
  0, 10,
  0, 0
), ncol = 2, byrow = TRUE)

study_area <- st_polygon(list(study_poly)) |>
  st_sfc(crs = 4326) |>
  st_sf(id = 1, geometry = geometry(.))
```

---

# 4. Defining habitat layers

Four habitat types are provided:

* Roads (horizontal line)
* Rivers (vertical line)
* Sand depot (point)
* Petrol stations (three points)

```r
roads <- st_linestring(matrix(c(0, 5, 10, 5), ncol = 2, byrow = TRUE)) |>
  st_sfc(crs = 4326) |> st_sf(id = 1, geometry = geometry(.))

rivers <- st_linestring(matrix(c(5, 0, 5, 10), ncol = 2, byrow = TRUE)) |>
  st_sfc(crs = 4326) |> st_sf(id = 1, geometry = geometry(.))

sand <- st_point(c(2, 8)) |>
  st_sfc(crs = 4326) |> st_sf(id = 1, geometry = geometry(.))

stations <- st_multipoint(rbind(c(8, 2), c(8, 8), c(2, 2))) |>
  st_cast("POINT") |> st_sfc(crs = 4326) |> 
  st_sf(id = 1:3, geometry = geometry(.))

habitats <- list(
  roads = roads,
  rivers = rivers,
  sand = sand,
  stations = stations
)
```

---

# 5. Simulated occurrence records

Occurrence points are simulated within the central region of the study area.

```r
n_occ <- 80
occ_coords <- data.frame(
  lon = runif(n_occ, 3, 7),
  lat = runif(n_occ, 3, 7)
)

occ_sf <- st_as_sf(occ_coords, coords = c("lon", "lat"), crs = 4326)
```

---

# 6. Background point generation

Background points are sampled uniformly inside the study area.

```r
bg_sf <- generate_background_points(
  occ_sf     = occ_sf,
  study_area = study_area,
  n_bg       = 400,
  method     = "random"
)
```

---

# 7. Distance calculation

Distances from both occurrence and background points to all habitats are computed.

```r
dist_list <- compute_all_distances_generic(
  occ_sf = occ_sf,
  bg_sf  = bg_sf,
  habitats = habitats
)
```

* `dist_list$occ` → a data frame (rows = occurrence points, columns = habitats)
* `dist_list$bg`  → same structure for background points

---

# 8. Distance–frequency tables

Long and wide formats are generated:

```r
freq_long <- build_frequency_table_generic_long(
  dist_occ = dist_list$occ,
  dist_bg  = dist_list$bg,
  breaks   = NULL,
  n_bins   = 6,
  method   = "pretty"
)

freq_wide <- build_frequency_table_generic_wide(freq_long)
```

`freq_long` has one row per habitat × distance bin.
`freq_wide` contains one row per distance bin, with columns:

* `sampling_<habitat>`
* `occurrence_<habitat>`

---

# 9. Exponential decay analysis

## 9.1 Multi-habitat decay curves

```r
p_decay <- plot_multi_habitat_decay(freq_long, ncol = 2)
p_decay
```

## 9.2 Decay statistics

```r
summary_decay <- generate_statistical_summary_multi(freq_wide)
summary_decay
```

This table includes decay coefficients, differences between sampling and occurrence decay, and statistical tests.

---

# 10. Trend analysis: LM and GAM models

## 10.1 Multi-habitat trend plots

```r
p_trends <- plot_multi_habitat_trends(
  freq_long,
  methods = c("lm", "gam"),
  degree  = 1,
  k       = 5,
  ncol    = 2
)
p_trends
```

* LM trends: linear (or polynomial) least-squares regression
* GAM trends: smooth, non-parametric fits using `mgcv::gam`

## 10.2 Trend summary

```r
trend_summary <- generate_trend_summary_multi(
  freq_wide,
  methods = c("lm", "gam"),
  degree  = 1,
  k       = 5
)
trend_summary
```

---

# 11. Machine-learning integration: Random Forests

Climate variables are simulated for demonstration purposes.

```r
env_occ <- data.frame(
  MAT = rnorm(nrow(dist_list$occ), mean = 18, sd = 1.5),
  MAP = rnorm(nrow(dist_list$occ), mean = 1100, sd = 80)
)

env_bg <- data.frame(
  MAT = rnorm(nrow(dist_list$bg), mean = 16.5, sd = 2.0),
  MAP = rnorm(nrow(dist_list$bg), mean = 1000, sd = 120)
)
```

## 11.1 Prepare data for modelling

```r
ml_data <- prepare_ml_data(
  dist_occ = dist_list$occ,
  dist_bg  = dist_list$bg,
  env_occ  = env_occ,
  env_bg   = env_bg
)
```

## 11.2 Fit random forest and compute importance

```r
rf_res <- fit_random_forest_importance(ml_data, n_trees = 500)
rf_res$importance
```

## 11.3 Importance plot

```r
ggplot(rf_res$importance,
       aes(x = reorder(variable, MeanDecreaseGini),
           y = MeanDecreaseGini)) +
  geom_col() +
  coord_flip() +
  labs(
    x = "Predictors",
    y = "Mean Decrease Gini",
    title = "Random Forest Variable Importance"
  ) +
  theme_minimal()
```

---

# 12. Concluding remarks

This vignette demonstrates the full workflow implemented in the WAN package:

* Background point generation
* Distance calculation using spatial objects
* Construction of distance–frequency tables
* Exponential decay modelling
* LM and GAM trend fitting
* Statistical summaries
* Random forest analysis combining habitat and climate covariates

The workflow is designed to support reproducible analyses of distance-based habitat preference, particularly for invasive species ecology or other applications requiring proximity-based inference.

---

# 13. Session information

For reproducibility:

```r
sessionInfo()
```

---
